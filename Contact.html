<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Race Results</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
</head>
<body>
    <section class="u-align-center u-clearfix u-section-1" id="sec-fab0">
        <div class="u-clearfix u-sheet u-sheet-1">
            <h2>Race Results</h2>
            <div class="u-expanded-width u-table u-table-responsive u-table-1">
                <table class="u-table-entity" id="table10">
                    <thead class="u-align-center u-custom-font u-font-montserrat u-palette-3-base u-table-header u-table-header-1">
                        <tr style="height: 38px;">
                            <td class="u-border-1 u-border-grey-dark-1 u-table-cell">BIB</td>
                            <td class="u-border-1 u-border-grey-dark-1 u-table-cell">Name</td>
                            <td class="u-border-1 u-border-grey-dark-1 u-table-cell">Gender</td>
                            <td class="u-border-1 u-border-grey-dark-1 u-table-cell">WS1<br>Black Lava</td>
                            <td class="u-border-1 u-border-grey-dark-1 u-table-cell">Finish</td>
                            <td class="u-border-1 u-border-grey-dark-1 u-table-cell">UNOFFICIAL</td>
                            <td class="u-border-1 u-border-grey-dark-1 u-table-cell">Rank</td>
                            <td class="u-border-1 u-border-grey-dark-1 u-table-cell">Status</td>
                        </tr>
                    </thead>
                    <tbody class="u-table-body"></tbody>
                </table>
                <table class="u-table-entity" id="table25">
                    <thead class="u-align-center u-custom-font u-font-montserrat u-palette-3-base u-table-header u-table-header-1">
                        <tr style="height: 25px;">
                            <td class="u-border-1 u-border-grey-dark-1 u-table-cell">BIB</td>
                            <td class="u-border-1 u-border-grey-dark-1 u-table-cell">Name</td>
                            <td class="u-border-1 u-border-grey-dark-1 u-table-cell">Gender</td>
                            <td class="u-border-1 u-border-grey-dark-1 u-table-cell">WS1<br>Black Lava</td>
                            <td class="u-border-1 u-border-grey-dark-1 u-table-cell">WS2<br>Red Lava</td>
                            <td class="u-border-1 u-border-grey-dark-1 u-table-cell">Finish</td>
                            <td class="u-border-1 u-border-grey-dark-1 u-table-cell">UNOFFICIAL</td>
                            <td class="u-border-1 u-border-grey-dark-1 u-table-cell">Rank</td>
                            <td class="u-border-1 u-border-grey-dark-1 u-table-cell">Status</td>
                        </tr>
                    </thead>
                    <tbody class="u-table-body"></tbody>
                </table>
                <table class="u-table-entity" id="table50">
                    <thead class="u-align-center u-custom-font u-font-montserrat u-palette-3-base u-table-header u-table-header-1">
                        <tr style="height: 25px;">
                            <td class="u-border-1 u-border-grey-dark-1 u-table-cell">BIB</td>
                            <td class="u-border-1 u-border-grey-dark-1 u-table-cell">Name</td>
                            <td class="u-border-1 u-border-grey-dark-1 u-table-cell">Gender</td>
                            <td class="u-border-1 u-border-grey-dark-1 u-table-cell">WS1<br>Black Lava</td>
                            <td class="u-border-1 u-border-grey-dark-1 u-table-cell">WS2<br>Red Lava</td>
                            <td class="u-border-1 u-border-grey-dark-1 u-table-cell">WS3<br>Tejataki</td>
                            <td class="u-border-1 u-border-grey-dark-1 u-table-cell">WS4<br>Red Lava 2</td>
                            <td class="u-border-1 u-border-grey-dark-1 u-table-cell">WS5<br>Black Lava 2</td>
                            <td class="u-border-1 u-border-grey-dark-1 u-table-cell">Finish</td>
                            <td class="u-border-1 u-border-grey-dark-1 u-table-cell">UNOFFICIAL</td>
                            <td class="u-border-1 u-border-grey-dark-1 u-table-cell">Rank</td>
                            <td class="u-border-1 u-border-grey-dark-1 u-table-cell">Status</td>
                        </tr>
                    </thead>
                    <tbody class="u-table-body"></tbody>
                </table>
                <table class="u-table-entity" id="table80">
                    <thead class="u-align-center u-custom-font u-font-montserrat u-palette-3-base u-table-header u-table-header-1">
                        <tr style="height: 25px;">
                            <td class="u-border-1 u-border-grey-dark-1 u-table-cell">BIB</td>
                            <td class="u-border-1 u-border-grey-dark-1 u-table-cell">Name</td>
                            <td class="u-border-1 u-border-grey-dark-1 u-table-cell">Gender</td>
                            <td class="u-border-1 u-border-grey-dark-1 u-table-cell">WS1<br>Black Lava</td>
                            <td class="u-border-1 u-border-grey-dark-1 u-table-cell">WS2<br>Red Lava</td>
                            <td class="u-border-1 u-border-grey-dark-1 u-table-cell">WS3<br>Tejataki</td>
                            <td class="u-border-1 u-border-grey-dark-1 u-table-cell">WS4<br>Samirenteng</td>
                            <td class="u-border-1 u-border-grey-dark-1 u-table-cell">WS5<br>Tejataki 2</td>
                            <td class="u-border-1 u-border-grey-dark-1 u-table-cell">WS6<br>Red Lava 2</td>
                            <td class="u-border-1 u-border-grey-dark-1 u-table-cell">WS7<br>Black Lava 2</td>
                            <td class="u-border-1 u-border-grey-dark-1 u-table-cell">Finish</td>
                            <td class="u-border-1 u-border-grey-dark-1 u-table-cell">UNOFFICIAL</td>
                            <td class="u-border-1 u-border-grey-dark-1 u-table-cell">Rank</td>
                            <td class="u-border-1 u-border-grey-dark-1 u-table-cell">Status</td>
                        </tr>
                    </thead>
                    <tbody class="u-table-body"></tbody>
                </table>
            </div>
            <button id="exportButton">UNOFFICIALto Excel</button>
        </div>
    </section>
    <script>
      document.addEventListener('DOMContentLoaded', function () {
          let fetchedData = [];

          fetch('https://detrac.id/checkoutcaldera/tbl_bib_bali.php')
              .then(response => response.json())
              .then(data => {
                  fetchedData = data;
                  const table10 = document.getElementById('table10').getElementsByTagName('tbody')[0];
                  const table25 = document.getElementById('table25').getElementsByTagName('tbody')[0];
                  const table50 = document.getElementById('table50').getElementsByTagName('tbody')[0];
                  const table80 = document.getElementById('table80').getElementsByTagName('tbody')[0];

                  const formatTime = (timeString) => {
                      if (!timeString) return '';
                      const parts = timeString.split(':');
                      const hours = parts[0].padStart(2, '0');
                      const minutes = parts[1].padStart(2, '0');
                      const seconds = parts[2] ? parts[2].padStart(2, '0') : '00';
                      return `${hours}:${minutes}:${seconds}`;
                  };

                  const createRows = (items, table, headers) => {
                      table.innerHTML = ''; // Clear existing rows
                      items.forEach((item) => {
                          let row = '<tr>';
                          headers.forEach(header => {
                              if (header.startsWith('ws_') || header === 'finish') {
                                  row += `<td class="u-border-1 u-border-grey-dark-1 u-table-cell">${formatTime(item[header]) || ''}</td>`;
                              } else {
                                  row += `<td class="u-border-1 u-border-grey-dark-1 u-table-cell">${item[header] || ''}</td>`;
                              }
                          });
                          row += '</tr>';
                          table.innerHTML += row;
                      });
                  };

                  const headers10km = ['no_bib', 'name', 'gender', 'ws_1', 'finish', 'AOT', 'rank_label', 'status'];
                  const headers25km = ['no_bib', 'name', 'gender', 'ws_1', 'ws_2', 'finish', 'AOT', 'rank_label', 'status'];
                  const headers50km = ['no_bib', 'name', 'gender', 'ws_1', 'ws_2', 'ws_3', 'ws_4', 'ws_5', 'finish', 'AOT', 'rank_label', 'status'];
                  const headers80km = ['no_bib', 'name', 'gender', 'ws_1', 'ws_2', 'ws_3', 'ws_4', 'ws_5', 'ws_6', 'ws_7', 'finish', 'AOT', 'rank_label', 'status'];

                  // Filter data based on category and populate tables
                  createRows(fetchedData.filter(item => item.category === '10_km'), table10, headers10km);
                  createRows(fetchedData.filter(item => item.category === '25_km'), table25, headers25km);
                  createRows(fetchedData.filter(item => item.category === '50_km'), table50, headers50km);
                  createRows(fetchedData.filter(item => item.category === '80_km'), table80, headers80km);

                  // Download Excel file automatically
                  const wb = XLSX.utils.book_new();
                  const exportTableToSheet = (tableId, sheetName) => {
                      const ws = XLSX.utils.table_to_sheet(document.getElementById(tableId));
                      XLSX.utils.book_append_sheet(wb, ws, sheetName);
                  };

                  exportTableToSheet('table10', '10_KM');
                  exportTableToSheet('table25', '25_KM');
                  exportTableToSheet('table50', '50_KM');
                  exportTableToSheet('table80', '80_KM');

                  XLSX.writeFile(wb, 'Race_Results.xlsx');

                  // Redirect to index page after download
                  window.location.href = 'index.html';
              });
      });
    </script>
</body>
</html>
